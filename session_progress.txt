CabEasy Project Documentation
Generated on: 2026-02-24

1) Project Purpose
CabEasy is a Flutter B2B travel marketplace app with two core user roles:
- Agent: posts travel requirements, tracks own requests, updates profile, raises complaints.
- Supplier: browses request feed and submits bids against requests.

2) Tech Stack
- Flutter + Material UI
- Provider for state management
- Firebase Auth (OTP) for authentication
- Cloud Firestore for data persistence
- n8n webhook integration for lead classification
- Utility packages: intl, uuid, shimmer, http

3) Application Entry and Routing
- App entry: `lib/main.dart`
  - Initializes Firebase
  - Registers providers: `AuthProvider`, `RequestProvider`, `BidProvider`
  - Launches `AuthWrapper`
- Auth routing: `lib/screens/auth_wrapper.dart`
  - Not logged in -> `LoginScreen`
  - Logged in but no profile -> `ProfileScreen`
  - Profile exists but not KYC-verified -> `KycVerificationScreen`
  - KYC complete + role supplier -> `SupplierHomeScreen`
  - KYC complete + role agent/default -> `AgentHomeScreen`

4) Folder-by-Folder Map
- `lib/constants/`
  - `app_colors.dart`: global color tokens
  - `app_text_styles.dart`: shared text styles
  - `app_config.dart`: app-level constants (n8n webhook URL)
- `lib/models/`
  - `user_model.dart`: user schema + firestore mapping
  - `request_model.dart`: request schema + firestore mapping
  - `bid_model.dart`: bid schema + firestore mapping
  - `booking_model.dart`: booking schema + firestore mapping
- `lib/services/`
  - `auth_service.dart`: OTP send/verify and user document bootstrap
  - `firestore_service.dart`: Firestore reads/writes/streams
  - `n8n_service.dart`: lead classification webhook call
- `lib/providers/`
  - `auth_provider.dart`: in-memory auth user state
  - `request_provider.dart`: request list + filter stream logic
  - `bid_provider.dart`: bid stream/actions
- `lib/screens/`
  - `login_screen.dart`: OTP login UI
  - `profile_screen.dart`: profile completion and role setup
  - `kyc_verification_screen.dart`: KYC gate/CTA screen
  - `home_screen.dart`: generic dashboard (legacy/simple)
  - `registration_screen.dart`: legacy registration UI
  - `agent/agent_home_screen.dart`: primary agent dashboard with 4 sections
  - `agent/agent_request_form_screen.dart`: standalone request form flow
  - `supplier/supplier_home_screen.dart`: supplier request feed + filters
  - `supplier/supplier_request_detail_screen.dart`: request details + bid status
  - `supplier/supplier_bid_screen.dart`: bid form and submission
- `lib/widgets/`
  - `common/app_card.dart`, `gradient_button.dart`, `loading_overlay.dart`, `status_badge.dart`
  - `request/request_card.dart`: supplier-side request preview card
  - `bid/bid_card.dart`: bid summary card

5) Firestore Collections in Current Code
- `users/{uid}`
  - fields used: uid, name, phone, role, isKycVerified, services, destinations, agency fields, kycStatus, timestamps
- `requests/{requestId}`
  - supplier flow reads open requests and bid counts
- `requests/{requestId}/bids/{bidId}`
  - supplier bid storage
- `bookings/{bookingId}`
  - booking snapshots
- `agentRequirements/{reqId}`
  - agent request posting in `AgentHomeScreen`
- `complaints/{complaintId}`
  - complaint submissions from agent panel

6) Key Runtime Workflows
- OTP authentication:
  - `AuthService.sendVerificationCode` -> Firebase phone auth
  - `AuthService.verifyAndSignIn` signs in and ensures user doc exists
- Profile onboarding:
  - `ProfileScreen` writes role + profile metadata
- KYC gate:
  - `KycVerificationScreen` checks `kycStatus` and routes to role home
- Agent request creation:
  - `AgentHomeScreen._submitRequest` writes to `agentRequirements`
  - Async `N8nService.triggerLeadClassification` webhook call
- Supplier bidding:
  - `SupplierBidScreen` creates bid
  - `FirestoreService.createBid` writes bid and increments request `bidCount`

7) Important UI/Code Notes
- Agent and supplier experiences are separated at screen level.
- Most long forms use `SingleChildScrollView` with mobile-first spacing.
- There is a data-path split:
  - agent dashboard writes `agentRequirements`
  - supplier feed reads `requests`
  This is a functional architecture decision/risk to reconcile if both sides must reference the same request objects.

8) UI Responsiveness and Widget Testing (Completed)
New test file added:
- `test/ui_responsiveness_test.dart`

What it validates:
- `RegistrationScreen` renders without exceptions
- Shared UI widgets render safely (`AppCard`, `GradientButton`, `StatusBadge`)
- `RequestCard` renders with long text content without overflow exceptions

Scenarios validated per target:
- 320x568 portrait
- 568x320 landscape
- 1024x1366 tablet-like
- Text scale 1.0 and 1.3
- Includes scroll interaction where scrollables exist

9) UI Overflow Fixes Implemented
- `lib/screens/registration_screen.dart`
  - Replaced bottom login-prompt `Row` with `Wrap` to avoid horizontal overflow on narrow widths.
- `lib/widgets/request/request_card.dart`
  - Header chips changed from tight `Row` to `Wrap`.
  - Agent and pax metadata section changed to wrapping layout with constrained/ellipsis text.
  - Date text now inside `Expanded` with ellipsis to avoid right overflow.

10) Test Status (Current)
Executed successfully:
- `flutter test`
Result:
- All tests passed.

11) Remaining Recommendations
- Decide whether agent requests should be unified into `requests` collection for supplier visibility.
- Add Firebase-mocked widget tests for Firebase-dependent screens (`LoginScreen`, `ProfileScreen`, `KycVerificationScreen`, `AgentHomeScreen`).
- Normalize non-ASCII/mojibake strings in some UI labels for production quality.

12) Latest Session Updates (2026-02-24 Evening)
- Fixed hard compile errors in `lib/screens/kyc_verification_screen.dart`:
  - Removed broken duplicate `_navigateToHome()` block and extra braces.
  - Removed unused imports and restored valid class/method structure.
- Fixed blocking errors in `lib/screens/agent/agent_profile_screen.dart`:
  - Resolved `AuthProvider` type ambiguity by aliasing provider import.
  - Fixed nullable access flow for `currentUser`.
  - Added typed method parameters using `UserModel`.
- Applied runtime-stability hardening in Firestore model parsing:
  - `lib/models/user_model.dart`
  - `lib/models/request_model.dart`
  - `lib/models/bid_model.dart`
  - `lib/models/booking_model.dart`
  Changes include null-safe map reads, safer numeric/date parsing, and defaults to prevent cast crashes on partial/missing Firestore fields.
- Improved OTP/auth flow robustness:
  - `lib/services/auth_service.dart`: improved verification completion handling, fallback error callback, and stronger user document defaults.
  - `lib/screens/login_screen.dart`: listener hookup for auto-submit, mounted checks in async callbacks, null guard for verificationId, safer focus handling, and removed unused import.
- Updated `test/widget_test.dart` away from default counter template to app-specific smoke coverage.
- Current verification status:
  - `flutter analyze`: no compile errors (remaining output is mostly lint/info warnings).
  - `flutter test`: currently failing due Firebase initialization dependency in widget environment (`[core/no-app] No Firebase App '[DEFAULT]' has been created`), requiring Firebase mock/init strategy in tests.
